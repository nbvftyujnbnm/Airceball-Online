<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airceball Online</title>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: 'Helvetica Neue', 'Arial', sans-serif; background-color: #f0f4f8; color: #333; display: flex; justify-content: center; align-items: flex-start; }
        .container { width: 100%; max-width: 1200px; height: 100%; background-color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        h2 { color: #1a3a6b; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.3em; margin-top: 25px; }
        #game-view-container { display: flex; flex-direction: column; height: 100dvh; width: 100%; }
        .game-header { flex-shrink: 0; background-color: #1a3a6b; color: white; padding: 8px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .game-main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; overflow-y: auto; position: relative; min-height: 0; }
        .game-footer { flex-shrink: 0; background-color: #f9f9f9; border-top: 1px solid #ddd; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .scoreboard { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; margin-bottom: 8px; }
        .scoreboard-team { display: flex; align-items: center; gap: 8px; }
        .team-name { font-size: 0.9em; color: #c0c0c0; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .team-score { font-size: 1.6em; font-weight: bold; }
        .scoreboard-inning { text-align: center; }
        .scoreboard-inning span:first-child { font-size: 0.7em; color: #c0c0c0; display: block; line-height: 1; }
        .inning-text { font-size: 1.2em; }
        .bso-counts { display: flex; justify-content: flex-end; gap: 15px; background-color: transparent; padding: 0; margin: 0; }
        .bso-item { display: flex; align-items: center; gap: 5px; }
        .bso-item span:first-child { font-size: 0.8em; color: #c0c0c0; }
        .bso-item span:last-child { font-size: 1.4em; font-weight: bold; color: #ffc107;}
        .log-container { display: none; }
        .log-toggle-btn { position: absolute; top: 10px; left: 10px; background-color: rgba(0,0,0,0.4); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9em; z-index: 5; width: auto; cursor: pointer; }
        .log-toggle-btn:hover { background-color: rgba(0,0,0,0.6); }
        .field-wrapper { width: 180px; height: 180px; margin: 0 auto 15px auto; }
        .field { position: relative; width: 100%; height: 100%; }
        .base { position: absolute; width: 25px; height: 25px; background-color: #e0e0e0; border: 2px solid #aaa; }
        #home { bottom: 0; left: 50%; transform: translateX(-50%); }
        #first { top: 50%; right: 0; transform: translateY(-50%); }
        #second { top: 0; left: 50%; transform: translateX(-50%); }
        #third { top: 50%; left: 0; transform: translateY(-50%); }
        .runner { background-color: #ffc107 !important; }
        #batter-info { background-color: #e3f2fd; border: 1px solid #90caf9; padding: 8px 12px; margin: 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; text-align: left; flex-wrap: wrap; gap: 10px; }
        .batter-name { font-size: 1.2em; font-weight: bold; color: #1a3a6b; }
        .batter-details { font-size: 0.8em; color: #555; }
        .ability-label { display: block; font-size: 0.7em; color: #888; }
        .ability-name { font-size: 1em; font-weight: bold; color: #1a3a6b; }
        #result { font-weight: bold; color: #1a3a6b; min-height: 40px; margin-bottom: 10px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; display: flex; justify-content: center; align-items: center; width: 100%; max-width: 400px; padding: 15px; box-sizing: border-box; font-size: clamp(1em, 4vw, 1.5em); }
        .controls { background-color: transparent; padding: 0; margin: 0; }
        .controls h2 { display: none; }
        .controls-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        button { background-color: #2a64b5; color: white; border: none; padding: 10px 5px; margin: 0; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.3s ease; width: 100%; }
        #no-swing-btn { grid-column: 1 / -1; }
        button:hover:not(:disabled) { background-color: #1a3a6b; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .no-swing { background-color: #6c757d; }
        .no-swing:hover:not(:disabled) { background-color: #5a6268; }
        #analytics-btn { background-color: #ff9800; }
        #analytics-btn:hover:not(:disabled) { background-color: #f57c00; }
        #setup-screen { padding: 20px; overflow-y: auto; height: 100%; }
        .team-setup { margin-bottom: 25px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        #start-game-btn { font-size: 1.2em; padding: 15px 30px; }
        .data-controls { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        #reset-data-btn, #export-data-btn, #import-data-btn, #show-all-data-btn { font-size: 0.9em; padding: 10px 15px; margin: 5px; }
        #reset-data-btn { background-color: #d32f2f; }
        #export-data-btn { background-color: #4caf50; }
        #import-data-btn { background-color: #03a9f4; }
        #show-all-data-btn { background-color: #607d8b; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; padding: 20px 30px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; text-align: left; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #888; cursor: pointer; }
        #data-log-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        #data-log-table th, #data-log-table td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        #ingame-log-body { font-size: 0.9em; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; }
        #ingame-log-body p { margin: 0 0 5px 0; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        #ingame-log-body p:last-child { border-bottom: none; margin-bottom: 0; }
        @media (min-width: 1000px) {
            .container { max-width: 1200px; padding: 25px; height: auto; }
            #game-view-container { display: grid; grid-template-columns: 300px 1fr 300px; grid-template-areas: "left center right"; gap: 25px; align-items: flex-start; height: auto; }
            .game-header { grid-area: left; display: block; position: relative; padding: 0; background-color: transparent; color: #333; box-shadow: none; }
            .game-main { grid-area: center; padding: 0; }
            .game-footer { grid-area: center; position: relative; margin-top: 20px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; box-shadow: none; }
            #analytics-btn { width: auto; margin: 5px; }
            .log-container { grid-area: right; display: block; border: 1px solid #ddd; border-radius: 8px; padding: 10px 15px; background-color: #f9f9f9; }
            #log-box { height: 550px; }
            .log-toggle-btn { display: none; }
            .scoreboard { display: grid; grid-template-columns: 1fr auto 1fr; background-color: #1a3a6b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 1.2em; }
            .scoreboard-team { display: block; text-align: center; }
            .bso-counts { display: flex; justify-content: space-around; background-color: #f1f1f1; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
            .bso-item { flex-direction: column; }
            .bso-item span:first-child { color: #888; } .bso-item span:last-child { color: #1a3a6b; }
            #batter-info { margin-bottom: 20px; padding: 12px 15px; }
            .controls h2 { display: block; color: #1a3a6b; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.3em; margin-top: 0; }
            .controls-grid { display: block; }
            button { margin: 5px; padding: 12px 20px; font-size: 1em; }
            #no-swing-btn { width: auto; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen"><h2>ゲーム設定</h2>
        <div>
            ゲームモード: 
            <select id="game-mode">
                <option value="pvp" selected>Player vs Player</option>
                <option value="pvc_classic">Player vs Classic CPU</option>
                <option value="pvc_rl">Player vs AI</option>
            </select>
        </div>
        <div style="margin: 15px 0;">
            イニング数: 
            <select id="inning-select">
                <option value="1">1イニング</option>
                <option value="3">3イニング</option>
                <option value="5">5イニング</option>
                <option value="9" selected>9イニング</option>
            </select>
        </div>
        <div id="cpu-setup" style="display: none; margin-top: 15px; padding: 10px; background-color: #e3f2fd; border-radius: 8px;">
            あなたが操作するチーム: 
            <select id="player-team-choice">
                <option value="0">先攻チーム</option>
                <option value="1">後攻チーム</option>
            </select>
        </div>
        <hr style="margin: 20px 0;">
        <h2>チームと選手の設定</h2>
        <div class="team-setup">
            <h3>先攻チーム</h3>
            <div>チーム名: <input type="text" id="team1-name" value="先攻チーム"></div>
            <div id="team1-players"></div>
        </div>
        <div class="team-setup">
            <h3>後攻チーム</h3>
            <div>チーム名: <input type="text" id="team2-name" value="後攻チーム"></div>
            <div id="team2-players"></div>
        </div>
        <button id="start-game-btn">ゲーム開始</button>
        <div class="data-controls">
            <button id="show-all-data-btn">全データ表示</button>
            <button id="export-data-btn">データエクスポート</button>
            <button id="import-data-btn">データインポート</button>
            <input type="file" id="import-file-input" accept=".json,.txt" style="display: none;">
            <button id="reset-data-btn">全データリセット</button>
        </div>
    </div>

    <div id="game-screen" style="display: none;"><div id="game-view-container">
            <header class="game-header">
                <div class="scoreboard">
                    <div class="scoreboard-team">
                        <span class="team-score" id="team1-score">0</span>
                        <span class="team-name" id="team1-display-name">TEAM 1</span>
                    </div>
                    <div class="scoreboard-inning">
                        <span>INNING</span>
                        <span id="inning" class="inning-text">1回表</span>
                    </div>
                    <div class="scoreboard-team">
                         <span class="team-name" id="team2-display-name">TEAM 2</span>
                        <span class="team-score" id="team2-score">0</span>
                    </div>
                </div>
                <div class="bso-counts">
                    <div class="bso-item"><span>B</span><span id="ball-count">0</span></div>
                    <div class="bso-item"><span>S</span><span id="strike-count">0</span></div>
                    <div class="bso-item"><span>O</span><span id="out-count">0</span></div>
                </div>
            </header>
            
            <main class="game-main">
                <button class="log-toggle-btn" onclick="showIngameLog()">ログ</button>
                <div class="field-wrapper">
                    <div class="field">
                        <div class="base" id="home"></div>
                        <div class="base" id="first"></div>
                        <div class="base" id="second"></div>
                        <div class="base" id="third"></div>
                    </div>
                </div>
                <div id="result">ゲーム開始！</div>
            </main>

            <footer class="game-footer">
                <div id="batter-info"></div>
                <div id="pitcher-controls" class="controls">
                    <h2>投球選択</h2>
                    <div class="controls-grid">
                        <button class="pitch-btn" data-pitch="1">ストレート</button>
                        <button class="pitch-btn" data-pitch="2">スライダー</button>
                        <button class="pitch-btn" data-pitch="3">カーブ</button>
                        <button class="pitch-btn" data-pitch="4">フォーク</button>
                        <button class="pitch-btn" data-pitch="5">チェンジアップ</button>
                    </div>
                </div>
                <div id="batter-controls" class="controls" style="display:none;">
                    <h2>打撃選択</h2>
                    <div class="controls-grid">
                        <button class="swing-btn" data-pitch="1">ストレート</button>
                        <button class="swing-btn" data-pitch="2">スライダー</button>
                        <button class="swing-btn" data-pitch="3">カーブ</button>
                        <button class="swing-btn" data-pitch="4">フォーク</button>
                        <button class="swing-btn" data-pitch="5">チェンジアップ</button>
                        <button id="no-swing-btn" class="no-swing">見送る</button>
                    </div>
                </div>
                <button id="analytics-btn">傾向分析</button> 
            </footer>

            <div class="log-container">
                <div id="log-box"></div>
            </div>
        </div>
    </div>
</div>

<div id="analytics-modal" class="modal-overlay"><div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h2 id="modal-title">傾向分析</h2>
        <div id="modal-body"></div>
    </div>
</div>

<div id="data-log-modal" class="modal-overlay"><div class="modal-content" style="max-width: 90vw;">
        <span class="modal-close-btn">&times;</span>
        <h2>全プレイデータログ</h2>
        <div id="data-log-body" style="max-height: 70vh; overflow-y: auto;"></div>
    </div>
</div>

<div id="ingame-log-modal" class="modal-overlay"><div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h2>プレイログ</h2>
        <div id="ingame-log-body" style="max-height: 70vh; overflow-y: auto;"></div>
    </div>
</div>


<script>
     //----------------------------------------
    // ゲームの状態管理
    //----------------------------------------
    const gameState = {
        teams: [
            { name: '先攻チーム', players: [], score: 0 },
            { name: '後攻チーム', players: [], score: 0 }
        ],
        gameStarted: false, inning: 1, isTop: true, outCount: 0,
        strikeCount: 0, ballCount: 0, pitchCountInPA: 0, 
        runners: [false, false, false], currentAttackerIndex: 0,
        batterRotations: [0, 0], currentPitcherChoice: null, chanceTarget: null,
        totalInnings: 9, 
        gameMode: 'pvp',
        cpuTeamIndex: null,
    };

    //----------------------------------------
    // データ記録＆分析用の定数と変数
    //----------------------------------------
    let gameLog = [];
    const LOG_STORAGE_KEY = 'airceballLog';

    const PITCHES = {
        1: { name: 'ストレート', type: 'strike' }, 2: { name: 'スライダー', type: 'ball' },
        3: { name: 'カーブ', type: 'strike' }, 4: { name: 'フォーク', type: 'ball' },
        5: { name: 'チェンジアップ', type: 'strike' },
    };
    const ABILITIES = { none: 0, sengugan: 1, nebari: 2, chance: 3 };
    const RESULTS = {
        strike: 1, foul: 2, ball: 3, goro_out: 4, double_play: 5,
        hit_1: 6, hit_2: 7, hit_3: 8, hit_4: 9
    };
    const PITCH_NAMES = { ...Object.fromEntries(Object.entries(PITCHES).map(([id, {name}]) => [id, name])), 0: '見送り' };
    const ABILITY_NAMES = { 0: 'なし', 1: '選球眼', 2: '粘り', 3: 'チャンス○'};
    const RESULT_NAMES = {
        1: 'ストライク', 2: 'ファール', 3: 'ボール', 4: 'ゴロアウト', 5: 'ゲッツー',
        6: '単打', 7: '二塁打', 8: '三塁打', 9: '本塁打'
    };

    // DOM要素
    const mainTitleEl = document.getElementById('main-title');
    const setupScreenEl = document.getElementById('setup-screen');
    const gameScreenEl = document.getElementById('game-screen');
    const analyticsModal = document.getElementById('analytics-modal');
    const dataLogModal = document.getElementById('data-log-modal');
    const inningEl = document.getElementById('inning');
    const outCountEl = document.getElementById('out-count');
    const strikeCountEl = document.getElementById('strike-count');
    const ballCountEl = document.getElementById('ball-count');
    const resultEl = document.getElementById('result');
    const firstBaseEl = document.getElementById('first');
    const secondBaseEl = document.getElementById('second');
    const thirdBaseEl = document.getElementById('third');
    const batterInfoEl = document.getElementById('batter-info');
    const pitcherControlsEl = document.getElementById('pitcher-controls');
    const batterControlsEl = document.getElementById('batter-controls');
    const analyticsBtn = document.getElementById('analytics-btn');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
    const dataLogBody = document.getElementById('data-log-body');
    const gameModeSelect = document.getElementById('game-mode');
    const cpuSetupEl = document.getElementById('cpu-setup');
    const playerTeamChoiceSelect = document.getElementById('player-team-choice');
    const logBoxEl = document.getElementById('log-box'); // ▼▼▼ 追加 ▼▼▼

    //----------------------------------------
    // データ記録・読み込み関数
    //----------------------------------------
    function saveLog() {
        try {
            localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(gameLog));
        } catch (e) { console.error("LocalStorageへの保存に失敗:", e); }
    }
    function loadLog() {
        const savedData = localStorage.getItem(LOG_STORAGE_KEY);
        if (savedData) {
            gameLog = JSON.parse(savedData);
            console.log(`LocalStorageから${gameLog.length}件のデータを読込`);
        }
    }
    function recordEvent(pitcherChoice, playerChoice, result) {
        const pitcherTeam = gameState.teams[(gameState.currentAttackerIndex + 1) % 2];
        const pitcherIndex = (gameState.currentAttackerIndex + 1) % 2;
        const batterTeam = gameState.teams[gameState.currentAttackerIndex];
        const batterIndex = gameState.currentAttackerIndex;
        const batter = getCurrentBatter();

        const pitcherIsComputer = gameState.gameMode.startsWith('pvc') && pitcherIndex === gameState.cpuTeamIndex;
        const batterIsComputer = gameState.gameMode.startsWith('pvc') && batterIndex === gameState.cpuTeamIndex;
        const computerName = gameState.gameMode === 'pvc_rl' ? 'AI' : 'CPU';

        const pitcherLogName = pitcherIsComputer ? computerName : pitcherTeam.name;
        const batterLogName = batterIsComputer ? computerName : batterTeam.name;

        const log = {
            pitcherTeamName: pitcherLogName,
            batterTeamName: batterLogName,
            pitcherScore: pitcherTeam.score,
            batterScore: batterTeam.score,
            batterAbilityId: ABILITIES[batter.ability],
            chanceTargetId: (batter.ability === 'chance') ? batter.chanceTarget : 0,
            pitchCountInPA: gameState.pitchCountInPA,
            outCount: gameState.outCount,
            strikeCount: gameState.strikeCount,
            ballCount: gameState.ballCount,
            runners: gameState.runners.map(r => r ? 1 : 0).join(','),
            pitchId: pitcherChoice,
            swingId: playerChoice === 'noswing' ? 0 : playerChoice,
            resultId: RESULTS[result]
        };
        gameLog.push(log);
        saveLog();
    }
    //----------------------------------------
    // ヘルパー・UI更新関数
    //----------------------------------------
    function getCurrentBatter() {
        const teamIndex = gameState.currentAttackerIndex;
        return gameState.teams[teamIndex].players[gameState.batterRotations[teamIndex]];
    }
    function toggleControls(showPitcher) {
        pitcherControlsEl.style.display = showPitcher ? 'block' : 'none';
        batterControlsEl.style.display = showPitcher ? 'none' : 'block';
    }
    function setButtonsDisabled(disabled) {
        document.querySelectorAll('#game-screen button').forEach(btn => { btn.disabled = disabled; });
    }
       function updateDisplay() {
        document.getElementById('team1-score').textContent = gameState.teams[0].score;
        document.getElementById('team2-score').textContent = gameState.teams[1].score;
document.getElementById('team1-display-name').textContent = gameState.teams[0].name;
        document.getElementById('team2-display-name').textContent = gameState.teams[1].name;
        inningEl.textContent = `${gameState.inning}回${gameState.isTop ? '表' : '裏'}`;
        outCountEl.textContent = gameState.outCount;
        strikeCountEl.textContent = gameState.strikeCount;
ballCountEl.textContent = gameState.ballCount;
        firstBaseEl.classList.toggle('runner', gameState.runners[0]);
        secondBaseEl.classList.toggle('runner', gameState.runners[1]);
        thirdBaseEl.classList.toggle('runner', gameState.runners[2]);
        if (gameState.gameStarted) {
            const batter = getCurrentBatter();
const team = gameState.teams[gameState.currentAttackerIndex];
            const abilityName = ABILITY_NAMES[ABILITIES[batter.ability]];
            const chanceTargetName = (batter.ability === 'chance') ? `(${PITCHES[batter.chanceTarget].name}狙い)` : '';
            
            // batterInfoEl の更新方法を変更
            batterInfoEl.innerHTML = `
                <div>
                    <span class="batter-details">${team.name} ${gameState.batterRotations[gameState.currentAttackerIndex] + 1}番</span>
                    <span class="batter-name">${batter.name}</span>
                </div>
                <div>
                    <span class="ability-label">特能</span>
                    <span class="ability-name">${abilityName}${chanceTargetName}</span>
                </div>
            `;
        }
    }

    // ▼▼▼ 変更 ▼▼▼
    // 操作指示用のメッセージを中央に表示
    function showMessage(msg) {
        resultEl.textContent = msg;
    }
     // プレイ結果をログボックスに表示
    function logMessage(msg) {
        const p = document.createElement('p');
        p.textContent = msg;

        // PC用ログボックスとモーダル用ログの両方に追加する
        const logBox = document.getElementById('log-box');
        const ingameLogBody = document.querySelector('#ingame-log-modal #ingame-log-body');
        
        // cloneNode(true)で要素を複製してそれぞれに追加する
        if (logBox) {
            const p1 = p.cloneNode(true);
            logBox.appendChild(p1);
            logBox.scrollTop = logBox.scrollHeight;
        }
        if (ingameLogBody) {
            const p2 = p.cloneNode(true);
            ingameLogBody.appendChild(p2);
            ingameLogBody.scrollTop = ingameLogBody.scrollHeight;
        }
    }

    // ▲▲▲ 変更ここまで ▲▲▲

    //----------------------------------------
    // ゲームロジック
    //----------------------------------------
    function nextBatter() {
        gameState.strikeCount = 0; gameState.ballCount = 0; gameState.pitchCountInPA = 0;
        const teamIndex = gameState.currentAttackerIndex;
        gameState.batterRotations[teamIndex] = (gameState.batterRotations[teamIndex] + 1) % gameState.teams[teamIndex].players.length;
        updateDisplay();
    }
    function changeInning() {
        if (gameState.isTop && gameState.inning >= gameState.totalInnings && gameState.teams[1].score > gameState.teams[0].score) {
            setTimeout(endGame, 1500);
            return;
        }
        if (!gameState.isTop && gameState.inning >= gameState.totalInnings && gameState.teams[0].score !== gameState.teams[1].score) {
            setTimeout(endGame, 1500);
            return;
        }
        gameState.outCount = 0; gameState.strikeCount = 0; gameState.ballCount = 0;
        gameState.pitchCountInPA = 0; gameState.runners = [false, false, false];
        if (!gameState.isTop) gameState.inning++;
        gameState.isTop = !gameState.isTop;
        gameState.currentAttackerIndex = (gameState.currentAttackerIndex + 1) % 2;
        logMessage('*** 攻守交代！ ***'); // 変更
        updateDisplay();
        setTimeout(startTurn, 2000);
    }

    function endGame() {
        let message = "ゲームセット！ ";
        const score1 = gameState.teams[0].score;
        const score2 = gameState.teams[1].score;
        if (score1 > score2) message += `${gameState.teams[0].name}の勝利！`;
        else if (score2 > score1) message += `${gameState.teams[1].name}の勝利！`;
        else message += "引き分け！";
        showMessage(message); // ゲーム終了は中央に表示
        logMessage(`*** ${message} ***`); // ログにも記録
        setButtonsDisabled(true);
        analyticsBtn.disabled = false;
    }
    function handleOut(count = 1) {
        gameState.outCount += count;
        if (gameState.outCount >= 3) {
            setTimeout(changeInning, 1500);
        } else {
            nextBatter();
            setTimeout(startTurn, 1500);
        }
        updateDisplay();
    }
     function handleStrike() {
        gameState.strikeCount++;
        updateDisplay();
        if (gameState.strikeCount >= 3) {
            const message = gameState.currentPitcherChoice === 'noswing' ? '見逃し三振！' : '空振り三振！';
            showMessage(message); // この行を追記
            logMessage(message);
            handleOut();
        } else {
            setTimeout(startTurn, 1500);
        }
    }

    function handleBall() {
        gameState.ballCount++;
        updateDisplay();
        if (gameState.ballCount >= 4) {
            showMessage('フォアボール！'); // この行を追記
            logMessage(`フォアボール！`);
            if (gameState.runners[0] && gameState.runners[1] && gameState.runners[2]) {
                const oldHomeScore = gameState.teams[1].score;
                gameState.teams[gameState.currentAttackerIndex].score++;
                const newHomeScore = gameState.teams[1].score;
                showMessage('押し出しで1点！'); // この行を追記
                logMessage('押し出しで1点！'); 
                if (!gameState.isTop && gameState.inning >= gameState.totalInnings && oldHomeScore <= gameState.teams[0].score && newHomeScore > gameState.teams[0].score) {
                    updateDisplay();
                    const sayonaraMessage = 'サヨナラ押し出し！';
                    showMessage(sayonaraMessage); // この行を追記
                    logMessage(sayonaraMessage); 
                    setTimeout(endGame, 1500);
                    return;
                }
            } else if (gameState.runners[0] && gameState.runners[1]) {
                gameState.runners[2] = true;
            } else if (gameState.runners[0]) {
                gameState.runners[1] = true;
            }
            gameState.runners[0] = true;
            nextBatter();
            setTimeout(startTurn, 1500);
        } else {
            setTimeout(startTurn, 1500);
        }
    }

    function handleFoul() {
        showMessage('ファール！'); // この行を追記
        logMessage('ファール！');
        if (gameState.strikeCount < 2) gameState.strikeCount++;
        updateDisplay();
        setTimeout(startTurn, 1500);
    }
    
        function advanceRunners(bases) {
        let newRunners = [false, false, false];
        let scoredRuns = 0;
        // 既存のランナーを進める (3塁から)
        for (let i = 2; i >= 0; i--) {
            if (gameState.runners[i]) {
                if (i + bases >= 3) {
                    scoredRuns++;
                } else {
                    newRunners[i + bases] = true;
                }
            }
        }
        // 打者走者を進める
        if (bases >= 4) { // ホームラン
            scoredRuns++;
        } else {
            newRunners[bases - 1] = true;
        }

        gameState.runners = newRunners;
        
        if (scoredRuns > 0) {
            gameState.teams[gameState.currentAttackerIndex].score += scoredRuns;
            logMessage(`${scoredRuns}点入りました！`);
        }
    }

//... handleHit関数の内容はそのまま ...

function handleHit(bases) {
        const hitTypes = { 1: 'ヒット！', 2: 'ツーベース！', 3: 'スリーベース！', 4: 'ホームラン！' };
        const oldHomeScore = gameState.teams[1].score;
        const message = hitTypes[bases];
        showMessage(message); // この行を追記
        logMessage(message); 
        advanceRunners(bases);
        const newHomeScore = gameState.teams[1].score;
        if (!gameState.isTop && gameState.inning >= gameState.totalInnings && oldHomeScore <= gameState.teams[0].score && newHomeScore > gameState.teams[0].score) {
            updateDisplay();
            const sayonaraMessage = bases === 4 ? 'サヨナラホームラン！' : 'サヨナラヒット！';
            showMessage(sayonaraMessage); // この行を追記
            logMessage(sayonaraMessage); 
            setTimeout(endGame, 1500);
            return;
        }
        nextBatter();
        setTimeout(startTurn, 1500);
    }

        function pitchAndSwing(pitcherChoice, playerChoice) {
        gameState.pitchCountInPA++;
        setButtonsDisabled(true);
        const pitcherPitch = PITCHES[pitcherChoice];
        const batter = getCurrentBatter();
        let message = `投手: ${pitcherPitch.name} |`;
        if (playerChoice !== 'noswing') message += ` 打者: ${PITCHES[playerChoice].name}狙い`;
        else message += ` 打者: 見送り`;
        logMessage(message);
        setTimeout(() => {
            if (playerChoice === 'noswing') {
                let isStrike = pitcherPitch.type === 'strike';
                if (pitcherChoice == '3' && batter.ability === 'sengugan') isStrike = false;
                recordEvent(pitcherChoice, playerChoice, isStrike ? 'strike' : 'ball');
    
                const resultMessage = isStrike ? 'ストライク！' : 'ボール！';
                showMessage(resultMessage); // この行を追記
                logMessage(resultMessage); 
                isStrike ? handleStrike() : handleBall();
                return;
            }
            const isGoro = (pitcherChoice == '5' && playerChoice == '3') || (pitcherChoice == '3' && playerChoice == '5');
     
            if (isGoro) {
                if (gameState.runners[0] && gameState.outCount < 2) {
                    recordEvent(pitcherChoice, playerChoice, 'double_play');
                    showMessage('ゲッツー！'); // この行を追記
                    logMessage('ゲッツー！'); gameState.runners[0] = false; handleOut(2); 
                } else {
                    recordEvent(pitcherChoice, playerChoice, 'goro_out');
                    showMessage('ゴロアウト！'); // この行を追記
                    logMessage('ゴロアウト！');
                    handleOut(1); 
                }
                return;
            }
            if (pitcherChoice === playerChoice) {
                let bases = 1;
                const isChance = gameState.runners[1] || gameState.runners[2];
                if (batter.ability === 'chance' && isChance && playerChoice === batter.chanceTarget) bases = 2;
                else if (playerChoice == '5') bases = 2;
                else if (playerChoice == '3') bases = 4;
                recordEvent(pitcherChoice, playerChoice, `hit_${bases}`);
                handleHit(bases);
                return;
            }
            const foulA = ['1', '2'], foulB = ['3', '4'];
            let isFoul = (batter.ability === 'nebari' && gameState.strikeCount === 2 && [...foulA, ...foulB].includes(pitcherChoice) && [...foulA, ...foulB].includes(playerChoice)) ||
            (foulA.includes(pitcherChoice) && foulA.includes(playerChoice)) || (foulB.includes(pitcherChoice) && foulB.includes(playerChoice));
            if (isFoul) {
                recordEvent(pitcherChoice, playerChoice, 'foul');
                handleFoul();
                return;
            }
            recordEvent(pitcherChoice, playerChoice, 'strike');
            showMessage('空振り！'); // この行を追記
            logMessage('空振り！');
            handleStrike();
        }, 1200);
    }

    //----------------------------------------
    // ゲームフロー制御
    //----------------------------------------
    function startTurn() {
        const isComputerTurn = gameState.gameMode.startsWith('pvc') && ((gameState.isTop && gameState.cpuTeamIndex === 1) || (!gameState.isTop && gameState.cpuTeamIndex === 0));

        if (isComputerTurn) {
            toggleControls(true);
            setButtonsDisabled(true);
            const thinkingMessage = gameState.gameMode === 'pvc_rl' ? "AIが投球を考えています..." : "CPUが投球を考えています...";
            showMessage(thinkingMessage);
            const delay = 1500 + Math.random() * 1000;
            if (gameState.gameMode === 'pvc_rl') setTimeout(cpuPitchAI, delay);
            else setTimeout(classicCpuPitchAI, delay);
        } else {
            showMessage(`${gameState.teams[(gameState.currentAttackerIndex + 1) % 2].name}、投球を選択してください。`);
            setButtonsDisabled(false);
            toggleControls(true);
        }
        updateDisplay();
    }
    function selectPitch(pitch) {
        gameState.currentPitcherChoice = pitch;
        const isComputerTurn = gameState.gameMode.startsWith('pvc') && ((gameState.isTop && gameState.cpuTeamIndex === 0) || (!gameState.isTop && gameState.cpuTeamIndex === 1));

        if (isComputerTurn) {
            toggleControls(false);
            setButtonsDisabled(true);
            const thinkingMessage = gameState.gameMode === 'pvc_rl' ? "AIが打撃を考えています..." : "CPUが打撃を考えています...";
            showMessage(thinkingMessage);
            const delay = 1500 + Math.random() * 1000;
            if (gameState.gameMode === 'pvc_rl') setTimeout(cpuBatAI, delay);
            else setTimeout(classicCpuBatAI, delay);
        } else {
            showMessage(`${gameState.teams[gameState.currentAttackerIndex].name}、打撃を選択してください。`);
            toggleControls(false);
            setButtonsDisabled(false);
        }
    }
    function selectBatterAction(action, pitch = null) {
        setButtonsDisabled(true);
        pitchAndSwing(gameState.currentPitcherChoice, action === 'swing' ? pitch : 'noswing');
    }
    
    //----------------------------------------
    // RL AI ロジック (API Call)
    //----------------------------------------
    async function callAIApi() {
        const batter = getCurrentBatter();
        const statePayload = {
            inning: gameState.inning, totalInnings: gameState.totalInnings,
            isTop: gameState.isTop, outCount: gameState.outCount,
            strikeCount: gameState.strikeCount, ballCount: gameState.ballCount,
            runners: gameState.runners, scores: [gameState.teams[0].score, gameState.teams[1].score],
            currentAttackerIndex: gameState.currentAttackerIndex,
            batterAbility: batter.ability, chanceTarget: batter.chanceTarget
        };
        try {
            const response = await fetch('/get-ai-move', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(statePayload)
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const data = await response.json();
            return data.move;
        } catch (error) {
            console.error("Failed to get AI move:", error);
            return Math.floor(Math.random() * 6); // Fallback
        }
    }
    async function cpuPitchAI() {
        const action = await callAIApi();
        const pitchChoice = (action % 5) + 1;
        console.log(`AI Pitcher chose action ${action}, resulting in pitch ${pitchChoice}`);
        selectPitch(String(pitchChoice));
    }
    async function cpuBatAI() {
        const action = await callAIApi();
        if (action === 5) {
            console.log(`AI Batter chose action ${action}, resulting in NO SWING`);
            selectBatterAction('noswing');
        } else {
            const swingChoice = (action % 5) + 1;
            console.log(`AI Batter chose action ${action}, resulting in SWING at ${swingChoice}`);
            selectBatterAction('swing', String(swingChoice));
        }
    }

    //----------------------------------------
    // Classic CPU ロジック
    //----------------------------------------
    function getWeightedRandom(choices) {
        const totalWeight = choices.reduce((sum, choice) => sum + choice.weight, 0);
        let random = Math.random() * totalWeight;
        for (const choice of choices) {
            if (random < choice.weight) return choice.value;
            random -= choice.weight;
        }
        return choices[choices.length - 1].value;
    }
    function classicCpuPitchAI() {
        let tendencyData = getTendencyData('batter', { matchOutCount: true, matchRunners: true });
        if (tendencyData.total === 0) tendencyData = getTendencyData('batter', { matchOutCount: false, matchRunners: false });
        let pitchChoices = Object.keys(PITCHES).map(id => ({ value: id, weight: 10 }));
        if (tendencyData.total > 0) {
            let maxSwingCount = 0, preferredSwing = null;
            for (const [swingId, count] of Object.entries(tendencyData.counts)) {
                if (swingId !== '0' && count > maxSwingCount) {
                    maxSwingCount = count; preferredSwing = swingId;
                }
            }
            if (preferredSwing) {
                const targetChoice = pitchChoices.find(c => c.value === preferredSwing);
                if (targetChoice) targetChoice.weight = 2;
            }
        }
        selectPitch(getWeightedRandom(pitchChoices));
    }
    function classicCpuBatAI() {
        if (Math.random() < 0.25) { selectBatterAction('noswing'); return; }
        let tendencyData = getTendencyData('pitcher', { matchOutCount: true, matchRunners: true });
        if (tendencyData.total === 0) tendencyData = getTendencyData('pitcher', { matchOutCount: false, matchRunners: false });
        let swingChoices = Object.keys(PITCHES).map(id => ({ value: id, weight: 1 }));
        if (tendencyData.total > 0) {
            swingChoices = Object.keys(PITCHES).map(id => ({ value: id, weight: (tendencyData.counts[id] || 0) + 1 }));
        }
        selectBatterAction('swing', getWeightedRandom(swingChoices));
    }

    //----------------------------------------
    // データ分析機能
    //----------------------------------------
    function getTendencyData(type, conditions) {
        const batterTeamName = gameState.teams[gameState.currentAttackerIndex].name;
        const pitcherTeamName = gameState.teams[(gameState.currentAttackerIndex + 1) % 2].name;
        const computerName = gameState.gameMode === 'pvc_rl' ? 'AI' : 'CPU';

        const isCpuPitching = gameState.gameMode.startsWith('pvc') && (gameState.currentAttackerIndex + 1) % 2 === gameState.cpuTeamIndex;
        const isCpuBatting = gameState.gameMode.startsWith('pvc') && gameState.currentAttackerIndex === gameState.cpuTeamIndex;

        const targetPitcherName = isCpuPitching ? computerName : pitcherTeamName;
        const targetBatterName = isCpuBatting ? computerName : batterTeamName;

        const runners = gameState.runners.map(r => r ? 1 : 0).join(',');

        const logs = gameLog.filter(log => {
            const teamToAnalyze = (type === 'pitcher') ? targetPitcherName : targetBatterName;
            const teamMatch = (type === 'pitcher') ? (log.pitcherTeamName === teamToAnalyze) : (log.batterTeamName === teamToAnalyze);
            if (!teamMatch) return false;
            if (conditions.matchOutCount && log.outCount !== gameState.outCount) return false;
            if (conditions.matchRunners && log.runners !== runners) return false;
            if (conditions.matchAbilityId !== undefined && log.batterAbilityId !== conditions.matchAbilityId) return false;
            return true;
        });

        const counts = logs.reduce((acc, log) => {
            let countKey = (type === 'pitcher') ? log.pitchId : log.swingId;
            if (type === 'batter' && log.batterAbilityId === 3 && log.swingId == log.chanceTargetId) countKey = `chance_${log.swingId}`;
            acc[countKey] = (acc[countKey] || 0) + 1;
            return acc;
        }, {});
        return { counts, total: logs.length };
    }

    function showAnalytics() {
        const isPitcherTurn = pitcherControlsEl.style.display === 'block';
        const type = isPitcherTurn ? 'batter' : 'pitcher';
        const computerName = gameState.gameMode === 'pvc_rl' ? 'AI' : 'CPU';
        
        const opponentIsCpu = (isPitcherTurn && gameState.currentAttackerIndex === gameState.cpuTeamIndex) || (!isPitcherTurn && (gameState.currentAttackerIndex + 1) % 2 === gameState.cpuTeamIndex);
        const opponentTeamName = opponentIsCpu ? computerName : (isPitcherTurn ? gameState.teams[gameState.currentAttackerIndex].name : gameState.teams[(gameState.currentAttackerIndex + 1) % 2].name);
        
        const currentBatter = getCurrentBatter();
        const currentAbilityId = ABILITIES[currentBatter.ability];
        const currentAbilityName = ABILITY_NAMES[currentAbilityId];

        modalTitle.textContent = isPitcherTurn ? `【${opponentTeamName}】の打撃傾向` : `【${opponentTeamName}】の投球傾向`;
        
        let modalHtml = "<h3>現在の状況と完全一致</h3>" + analyzeTendency(type, { matchOutCount: true, matchRunners: true }) +
                        "<h3>ランナー状況のみ一致</h3>" + analyzeTendency(type, { matchOutCount: false, matchRunners: true }) +
                        "<h3>アウトカウントのみ一致</h3>" + analyzeTendency(type, { matchOutCount: true, matchRunners: false }) +
                        "<h3>全体の傾向</h3>" + analyzeTendency(type, { matchOutCount: false, matchRunners: false });

        if (currentAbilityId !== ABILITIES.none) {
            const analysisTitle = isPitcherTurn ? `vs 特能「${currentAbilityName}」持ち打者` : `自特能「${currentAbilityName}」の場合`;
            modalHtml += `<h3>${analysisTitle}の傾向</h3>` + analyzeTendency(type, { matchOutCount: false, matchRunners: false, matchAbilityId: currentAbilityId });
        }
        modalBody.innerHTML = modalHtml;
        analyticsModal.style.display = 'flex';
    }
    
    function analyzeTendency(type, conditions) {
        const { counts, total } = getTendencyData(type, conditions);
        if (total === 0) return '<p>該当データなし</p>';
        let html = '<ul>';
        Object.entries(counts).sort(([, a], [, b]) => b - a).forEach(([k, count]) => {
            let name;
            if (type === 'pitcher') {
                name = PITCH_NAMES[k];
            } else { 
                if (String(k).startsWith('chance_')) {
                    const pitchId = k.split('_')[1];
                    name = `${PITCH_NAMES[pitchId]}狙い (チャンス○)`;
                } else {
                    name = (k == '0') ? '見送り' : `${PITCH_NAMES[k]}狙い`;
                }
            }
            html += `<li><strong>${name}</strong>: ${((count / total) * 100).toFixed(1)}% (${count}/${total}回)</li>`;
        });
        return html + '</ul>';
    }

    //----------------------------------------
    // 全データ表示機能
    //----------------------------------------
    function showAllData() {
        if (gameLog.length === 0) {
            dataLogBody.innerHTML = '<p>記録されたデータがありません。</p>';
            dataLogModal.style.display = 'flex';
            return;
        }
        let tableHtml = '<table id="data-log-table"><thead><tr>' +
            '<th>投手</th><th>打者</th><th>特能</th><th>スコア</th><th>アウト</th>' +
            '<th>カウント</th><th>走者</th><th>投球</th><th>打撃</th><th>結果</th>' +
            '</tr></thead><tbody>';
        
        [...gameLog].reverse().forEach(log => {
            let abilityStr = ABILITY_NAMES[log.batterAbilityId];
            if (log.batterAbilityId === 3 && log.chanceTargetId) abilityStr += `(${PITCH_NAMES[log.chanceTargetId]})`;
            tableHtml += `<tr>
                <td>${log.pitcherTeamName}</td> <td>${log.batterTeamName}</td>
                <td>${abilityStr}</td> <td>${log.pitcherScore} - ${log.batterScore}</td>
                <td>${log.outCount}</td> <td>S:${log.strikeCount} B:${log.ballCount}</td>
                <td>${log.runners.replace(/1/g, '●').replace(/0/g, '-')}</td>
                <td>${PITCH_NAMES[log.pitchId]}</td> <td>${PITCH_NAMES[log.swingId]}</td>
                <td>${RESULT_NAMES[log.resultId]}</td>
            </tr>`;
        });
        tableHtml += '</tbody></table>';
        dataLogBody.innerHTML = tableHtml;
        dataLogModal.style.display = 'flex';
    }
    
    //----------------------------------------
    // データ入出力機能
    //----------------------------------------
    function exportData() {
        if (gameLog.length === 0) { alert('エクスポートするデータがありません。'); return; }
        const dataStr = JSON.stringify(gameLog, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `airceball_log_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert(`${gameLog.length}件のデータをエクスポートしました。`);
    }
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!Array.isArray(importedData)) throw new Error('データ形式が正しくありません。');
                const choice = prompt(`インポートモードを選択してください:\n1: 既存のデータに追加する\n2: 既存のデータを置き換える`, '1');
                if (choice === '1') {
                    gameLog = gameLog.concat(importedData);
                    alert(`${importedData.length}件のデータを追加しました。合計: ${gameLog.length}件`);
                } else if (choice === '2') {
                    gameLog = importedData;
                    alert(`${importedData.length}件のデータに置き換えました。`);
                } else {
                    alert('インポートをキャンセルしました。');
                    return;
                }
                saveLog();
            } catch (error) {
                alert('ファイルの読み込みに失敗しました。有効なJSONデータではありません。\n' + error.message);
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }
    
    //----------------------------------------
    // セットアップと初期化
    //----------------------------------------
    function createPlayerSetupHTML(teamIndex) {
        let html = '';
        const defaultNames = teamIndex === 1 ? ['選手A', '選手B', '選手C'] : ['選手X', '選手Y', '選手Z'];
        for (let i = 0; i < 3; i++) {
            html += `<div class="player-setup">
                    ${i+1}番: <input type="text" id="t${teamIndex}-p${i}-name" value="${defaultNames[i]}" size="8">
                    特能: <select id="t${teamIndex}-p${i}-ability" data-team="${teamIndex}" data-player="${i}">
                            <option value="none">なし</option> <option value="sengugan">選球眼</option>
                            <option value="nebari">粘り</option> <option value="chance">チャンス○</option>
                         </select>
                    <span id="t${teamIndex}-p${i}-chance-options" style="display:none;">
                        狙い: <select id="t${teamIndex}-p${i}-chance-target">
                            <option value="2">スライダー</option> <option value="4">フォーク</option>
                        </select>
                    </span></div>`;
        }
        return html;
    }
    function initSetup() {
        document.getElementById('team1-players').innerHTML = createPlayerSetupHTML(1);
        document.getElementById('team2-players').innerHTML = createPlayerSetupHTML(2);
        document.querySelectorAll('select[id$="-ability"]').forEach(select => {
            select.addEventListener('change', (e) => {
                const team = e.target.dataset.team, player = e.target.dataset.player;
                document.getElementById(`t${team}-p${player}-chance-options`).style.display = e.target.value === 'chance' ? 'inline' : 'none';
            });
        });
        gameModeSelect.addEventListener('change', (e) => {
            cpuSetupEl.style.display = e.target.value.startsWith('pvc') ? 'block' : 'none';
        });
        loadLog();
    }
       function startGame() {
        gameState.totalInnings = parseInt(document.getElementById('inning-select').value, 10);
       gameState.gameMode = gameModeSelect.value;
        if (gameState.gameMode.startsWith('pvc')) {
            gameState.cpuTeamIndex = parseInt(playerTeamChoiceSelect.value) === 0 ?
1 : 0;
            const cpuTeamNameInput = document.getElementById(`team${gameState.cpuTeamIndex + 1}-name`);
            const suffix = gameState.gameMode === 'pvc_rl' ?
' [AI]' : ' [CPU]';
            if (!cpuTeamNameInput.value.includes('[AI]') && !cpuTeamNameInput.value.includes('[CPU]')) {
                cpuTeamNameInput.value += suffix;
}
        } else {
            gameState.cpuTeamIndex = null;
}

        gameState.teams[0].name = document.getElementById('team1-name').value;
        gameState.teams[1].name = document.getElementById('team2-name').value;
if(gameState.teams[0].name.trim() === gameState.teams[1].name.trim()) {
            alert("警告: チーム名が同じです。データ分析が正しく機能しない可能性があります。");
}
        for (let t = 1; t <= 2; t++) {
            gameState.teams[t-1].players = [];
for (let p = 0; p < 3; p++) {
                gameState.teams[t-1].players.push({
                    name: document.getElementById(`t${t}-p${p}-name`).value,
                    ability: document.getElementById(`t${t}-p${p}-ability`).value,
                    chanceTarget: document.getElementById(`t${t}-p${p}-chance-target`).value
            
    });
            }
        }
        gameState.gameStarted = true;
        // mainTitleEl の行を削除
        setupScreenEl.style.display = 'none';
        gameScreenEl.style.display = 'block';
        logMessage('*** ゲーム開始！ ***');
// 変更
        startTurn();
}

    // ----------------------------------------
    // 初期化とイベントリスナー
    // ----------------------------------------
    
    // ▼▼▼ この関数をまるごと追加 ▼▼▼
    function showIngameLog() {
        const modal = document.getElementById('ingame-log-modal');
        if (modal) modal.style.display = 'flex';
    }
    
    // イベントリスナー
    document.getElementById('start-game-btn').addEventListener('click', startGame);
    analyticsBtn.addEventListener('click', showAnalytics);
    document.querySelectorAll('.pitch-btn').forEach(b => b.addEventListener('click', () => selectPitch(b.dataset.pitch)));
    document.querySelectorAll('.swing-btn').forEach(b => b.addEventListener('click', () => selectBatterAction('swing', b.dataset.pitch)));
    document.getElementById('no-swing-btn').addEventListener('click', () => selectBatterAction('noswing'));
    document.getElementById('show-all-data-btn').addEventListener('click', showAllData);
    document.getElementById('reset-data-btn').addEventListener('click', () => {
        if (confirm('本当に全プレイデータを削除しますか？\nこの操作は元に戻せません。')) {
            localStorage.removeItem(LOG_STORAGE_KEY);
            gameLog = [];
            alert('全データをリセットしました。');
        }
    });
    document.getElementById('export-data-btn').addEventListener('click', exportData);
    document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
    document.getElementById('import-file-input').addEventListener('change', importData);

    // 全てのモーダル共通のクローズ処理
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    });

    // ゲーム初期化
    initSetup();
</script>
</body>
</html>
