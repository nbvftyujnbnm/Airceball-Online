<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airceball Online - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="header-container"></div>
<div class="container home-container">
    <div class="setup-card">
        <h2 class="setup-title">ホーム</h2>
        <div class="home-menu">
            <a href="game.html" class="home-btn">ゲーム開始</a>
            <a href="rules.html" class="home-btn alt">ルール</a>
            <a href="version.html" class="home-btn alt">バージョン情報</a>
            <a href="https://forms.gle/QMpqCJGzdcHoZVYY8" target="_blank" rel="noopener noreferrer" class="home-btn alt">要望フォーム</a>
        </div>
    </div>

    <div class="setup-card data-controls">
        <h3 class="data-controls-title">データ管理</h3>
        <div class="data-buttons-grid">
            <button class="data-btn" id="show-all-data-btn">全データ表示</button>
            <button class="data-btn" id="reset-data-btn">全データリセット</button>
            <button class="data-btn" id="export-data-btn">エクスポート</button>
            <button class="data-btn" id="import-data-btn">インポート</button>
            <input type="file" id="import-file-input" accept=".json,.txt" style="display: none;">
        </div>
    </div>
</div>

<div id="data-log-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 90vw;">
        <span class="modal-close-btn">&times;</span>
        <h2>全プレイデータログ</h2>
        <div id="data-log-body" style="max-height: 70vh; overflow-y: auto;"></div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- データ管理機能 ---
    let gameLog = [];
    const LOG_STORAGE_KEY = 'airceballLog';

    const PITCHES = {
        1: { name: 'ストレート' }, 2: { name: 'スライダー' },
        3: { name: 'カーブ' }, 4: { name: 'フォーク' },
        5: { name: 'チェンジアップ' },
    };
    const PITCH_NAMES = { ...Object.fromEntries(Object.entries(PITCHES).map(([id, {name}]) => [id, name])), 0: '見送り' };
    const ABILITY_NAMES = { 0: 'なし', 1: '選球眼', 2: '粘り', 3: 'チャンス○'};
    const RESULT_NAMES = {
        1: 'ストライク', 2: 'ファール', 3: 'ボール', 4: 'ゴロアウト', 5: 'ゲッツー',
        6: '単打', 7: '二塁打', 8: '三塁打', 9: '本塁打'
    };

    function saveLog() {
        try {
            localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(gameLog));
        } catch (e) { console.error("LocalStorageへの保存に失敗:", e); }
    }

    function loadLog() {
        const savedData = localStorage.getItem(LOG_STORAGE_KEY);
        if (savedData) {
            try {
                gameLog = JSON.parse(savedData);
                console.log(`LocalStorageから${gameLog.length}件のデータを読込`);
            } catch (e) {
                console.error("LocalStorageからのデータ読み込みに失敗:", e);
                gameLog = [];
            }
        }
    }

    function showAllData() {
        const dataLogBody = document.getElementById('data-log-body');
        const dataLogModal = document.getElementById('data-log-modal');
        if (!dataLogBody || !dataLogModal) return;

        if (gameLog.length === 0) {
            dataLogBody.innerHTML = '<p>記録されたデータがありません。</p>';
        } else {
            let tableHtml = '<table id="data-log-table"><thead><tr>' +
                '<th>投手</th><th>打者</th><th>特能</th><th>スコア</th><th>アウト</th>' +
                '<th>カウント</th><th>走者</th><th>投球</th><th>打撃</th><th>結果</th>' +
                '</tr></thead><tbody>';
            
            [...gameLog].reverse().forEach(log => {
                let abilityStr = ABILITY_NAMES[log.batterAbilityId] || '不明';
                if (log.batterAbilityId === 3 && log.chanceTargetId) {
                    abilityStr += `(${PITCH_NAMES[log.chanceTargetId] || '?'})`;
                }
                tableHtml += `<tr>
                    <td>${log.pitcherTeamName || ''}</td> <td>${log.batterTeamName || ''}</td>
                    <td>${abilityStr}</td> <td>${log.pitcherScore} - ${log.batterScore}</td>
                    <td>${log.outCount}</td> <td>S:${log.strikeCount} B:${log.ballCount}</td>
                    <td>${(log.runners || '').replace(/1/g, '●').replace(/0/g, '-')}</td>
                    <td>${PITCH_NAMES[log.pitchId] || '不明'}</td> <td>${PITCH_NAMES[log.swingId] || '不明'}</td>
                    <td>${RESULT_NAMES[log.resultId] || '不明'}</td>
                </tr>`;
            });
            tableHtml += '</tbody></table>';
            dataLogBody.innerHTML = tableHtml;
        }
        dataLogModal.style.display = 'flex';
    }

    function exportData() {
        if (gameLog.length === 0) { alert('エクスポートするデータがありません。'); return; }
        const dataStr = JSON.stringify(gameLog, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `airceball_log_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert(`${gameLog.length}件のデータをエクスポートしました。`);
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!Array.isArray(importedData)) throw new Error('データ形式が正しくありません。');
                const choice = prompt(`インポートモードを選択してください:\n1: 既存のデータに追加する\n2: 既存のデータを置き換える`, '1');
                if (choice === '1') {
                    gameLog = gameLog.concat(importedData);
                    alert(`${importedData.length}件のデータを追加しました。合計: ${gameLog.length}件`);
                } else if (choice === '2') {
                    gameLog = importedData;
                    alert(`${importedData.length}件のデータに置き換えました。`);
                } else {
                    alert('インポートをキャンセルしました。');
                    return;
                }
                saveLog();
            } catch (error) {
                alert('ファイルの読み込みに失敗しました。有効なJSONデータではありません。\n' + error.message);
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }
    
    // イベントリスナーの設定
    document.getElementById('show-all-data-btn').addEventListener('click', showAllData);
    document.getElementById('reset-data-btn').addEventListener('click', () => {
        if (confirm('本当に全プレイデータを削除しますか？\nこの操作は元に戻せません。')) {
            localStorage.removeItem(LOG_STORAGE_KEY);
            gameLog = [];
            alert('全データをリセットしました。');
        }
    });
    document.getElementById('export-data-btn').addEventListener('click', exportData);
    document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
    document.getElementById('import-file-input').addEventListener('change', importData);

    // モーダルを閉じる処理
    const modal = document.getElementById('data-log-modal');
    if(modal) {
        modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    }

    // 初期化
    loadLog();
});
</script>
<script src="header.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-655QVJR4CE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-655QVJR4CE');
</script>
</body>
</html>
